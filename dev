#!/usr/bin/env bash

function install {
    npm install
}

function build {
    npm run build
}

function watch {
    npm run watch
}

function format {
    npm run format
}

function docs {
    mkdir -p docs/api &&
        npx typedoc src --out docs/api --mode modules --ignoreCompilerErrors
}

function t {
    test_prog_ext node test.js &&
        test_lang0 &&
        test_lang1 &&
        true
}

function test_lang0 {
    lang0="./bin/lang0.js"

    for file in $(find . | grep "^\./examples/lang0" | grep "\.cic$")
    do
        echo ""
        echo "[test lang0] $file"
        if ! time $lang0 eval $file
        then
            exit 1
        fi
    done
}

function test_lang1 {
    lang1="./bin/lang1.js"

    for file in $(find . | grep "^\./examples/lang1" | grep "\.cic$")
    do
        echo ""
        echo "[test lang1] $file"
        if ! time $lang1 eval $file
        then
            exit 1
        fi
    done
}

function test_prog_ext {
    prog=$1
    ext=$2

    for file in $(find . | grep "^\./lib" | grep "\.${ext}$")
    do
        echo ""
        echo "[test] $file"
        if ! time $prog $file
        then
            exit 1
        fi
    done
}

function h {
    echo "commands:"
    for subcommand in $(declare -F | sed 's/declare -f//g')
    do
        echo "  $subcommand"
    done
}

if [ $# == 0 ]
then
    h
else
    for TASK in $@
    do
        $TASK
    done
fi

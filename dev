#!/usr/bin/env node

const { run, test, expect, snapshot, info } = require("@xieyuheng/test-runner")
const changeCase = require("change-case")
const path = require("path")
const fs = require("fs")

let commands = {}

commands.t = async () => {
  await commands.test_all()
}

commands.test_all = async () => {
  await commands.test_lib()
  await commands.test_impression()
  await commands.test_cicada()
}

commands.test_lib = async () => {
  await test("node $file", { file: "lib/**/*.test.js" }, expect.ok)
}

commands.test_impression = async () => {
  await test(
    "node $file",
    { file: "lib/**/*.impression.js" },
    snapshot.out(({ file }) =>
      path.resolve("snapshot", changeCase.paramCase(file) + ".out")
    )
  )
}

commands.test_cicada = async () => {
  await test(
    "./bin/cic.js $file",
    { file: "examples/cicada/out/**.cic" },
    snapshot.out(({ file }) => file + ".out")
  )

  await test(
    "./bin/cic.js $file",
    { file: "examples/cicada/err/**.cic" },
    snapshot.err(({ file }) => file + ".err")
  )
}

info()

run(commands)
